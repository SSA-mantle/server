<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pigeon3.ssamantle.adapter.out.rdb.record.mapper.RecordMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="recordResultMap" type="com.pigeon3.ssamantle.adapter.out.rdb.record.entity.RecordEntity">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="problemId" column="problem_id"/>
        <result property="failCount" column="fail_count"/>
        <result property="solvedAt" column="solved_at"/>
        <result property="giveUpAt" column="give_up_at"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 기록 저장 -->
    <insert id="insert" parameterType="com.pigeon3.ssamantle.adapter.out.rdb.record.entity.RecordEntity"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO records (
            user_id,
            problem_id,
            fail_count,
            solved_at,
            give_up_at,
            created_at
        ) VALUES (
            #{userId},
            #{problemId},
            #{failCount},
            #{solvedAt},
            #{giveUpAt},
            #{createdAt}
        )
    </insert>

    <!-- 기록 업데이트 -->
    <update id="update" parameterType="com.pigeon3.ssamantle.adapter.out.rdb.record.entity.RecordEntity">
        UPDATE records
        SET
            fail_count = #{failCount},
            solved_at = #{solvedAt},
            give_up_at = #{giveUpAt}
        WHERE id = #{id}
    </update>

    <!-- ID로 기록 조회 -->
    <select id="findById" parameterType="long" resultMap="recordResultMap">
        SELECT
            id,
            user_id,
            problem_id,
            fail_count,
            solved_at,
            give_up_at,
            created_at
        FROM records
        WHERE id = #{id}
    </select>

    <!-- 사용자 ID와 문제 ID로 기록 조회 -->
    <select id="findByUserIdAndProblemId" resultMap="recordResultMap">
        SELECT
            id,
            user_id,
            problem_id,
            fail_count,
            solved_at,
            give_up_at,
            created_at
        FROM records
        WHERE user_id = #{userId}
          AND problem_id = #{problemId}
    </select>

    <!-- 사용자 게임 통계 조회 -->
    <select id="findStatisticsByUserId" parameterType="long" resultType="com.pigeon3.ssamantle.adapter.out.rdb.record.dto.GameStatisticsDataDto">
        SELECT
            COUNT(*) as totalGamesPlayed,
            SUM(CASE WHEN solved_at IS NOT NULL THEN 1 ELSE 0 END) as successfulGames,
            ROUND(AVG(CASE WHEN solved_at IS NOT NULL THEN fail_count ELSE NULL END), 2) as averageAttempts
        FROM records
        WHERE user_id = #{userId}
    </select>

</mapper>
