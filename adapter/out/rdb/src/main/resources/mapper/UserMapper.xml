<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pigeon3.ssamantle.adapter.out.rdb.user.mapper.UserMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="userResultMap" type="com.pigeon3.ssamantle.adapter.out.rdb.user.entity.UserEntity">
        <id property="id" column="id"/>
        <result property="email" column="email"/>
        <result property="password" column="password"/>
        <result property="role" column="role"/>
        <result property="nickname" column="nickname"/>
        <result property="todaySolve" column="today_solve"/>
        <result property="longestCont" column="longest_cont"/>
        <result property="nowCont" column="now_cont"/>
        <result property="isDelete" column="is_delete"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deletedAt" column="deleted_at"/>
    </resultMap>

    <!-- 사용자 저장 -->
    <insert id="insert" parameterType="com.pigeon3.ssamantle.adapter.out.rdb.user.entity.UserEntity"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO users (
            email,
            password,
            role,
            nickname,
            today_solve,
            longest_cont,
            now_cont,
            is_delete,
            created_at,
            updated_at
        ) VALUES (
            #{email},
            #{password},
            #{role},
            #{nickname},
            #{todaySolve},
            #{longestCont},
            #{nowCont},
            #{isDelete},
            #{createdAt},
            #{updatedAt}
        )
    </insert>

    <!-- 이메일 중복 확인 -->
    <select id="existsByEmail" parameterType="string" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM users
            WHERE email = #{email}
              AND is_delete = false
        )
    </select>

    <!-- 닉네임 중복 확인 -->
    <select id="existsByNickname" parameterType="string" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM users
            WHERE nickname = #{nickname}
              AND is_delete = false
        )
    </select>

    <!-- ID로 사용자 조회 -->
    <select id="findById" parameterType="long" resultMap="userResultMap">
        SELECT
            id,
            email,
            password,
            role,
            nickname,
            today_solve,
            longest_cont,
            now_cont,
            is_delete,
            created_at,
            updated_at,
            deleted_at
        FROM users
        WHERE id = #{id}
    </select>

    <!-- 이메일로 사용자 조회 -->
    <select id="findByEmail" parameterType="string" resultMap="userResultMap">
        SELECT
            id,
            email,
            password,
            role,
            nickname,
            today_solve,
            longest_cont,
            now_cont,
            is_delete,
            created_at,
            updated_at,
            deleted_at
        FROM users
        WHERE email = #{email}
    </select>

    <!-- 사용자 정보 업데이트 -->
    <update id="update" parameterType="com.pigeon3.ssamantle.adapter.out.rdb.user.entity.UserEntity">
        UPDATE users
        SET
            password = #{password},
            nickname = #{nickname},
            role = #{role},
            today_solve = #{todaySolve},
            longest_cont = #{longestCont},
            now_cont = #{nowCont},
            is_delete = #{isDelete},
            updated_at = #{updatedAt},
            deleted_at = #{deletedAt}
        WHERE id = #{id}
    </update>

    <!-- 여러 사용자를 ID로 조회 -->
    <select id="findByIds" resultMap="userResultMap">
        SELECT
            id,
            email,
            password,
            role,
            nickname,
            today_solve,
            longest_cont,
            now_cont,
            is_delete,
            created_at,
            updated_at,
            deleted_at
        FROM users
        WHERE id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_delete = false
    </select>

    <!-- 일자 변경 시: 모든 사용자 todaySolve 초기화 + (미해결자는 nowCont=0) -->
    <update id="resetTodaySolveForAll">
        UPDATE users
        SET
            now_cont = CASE WHEN today_solve = false THEN 0 ELSE now_cont END,
            today_solve = false,
            updated_at = NOW(6)
        WHERE is_delete = false
    </update>

</mapper>
